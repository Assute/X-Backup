<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤‡ä»½è¯¦æƒ… - X Backup ç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f8fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1da1f2, #0d8bd9);
      color: #fff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-right span {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-light {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn-light:hover {
      background: rgba(255,255,255,0.3);
    }

    .container {
      padding: 24px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #1da1f2;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .page-title {
      font-size: 24px;
      color: #333;
      margin-bottom: 24px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #eee;
    }

    .tab {
      flex: 1;
      padding: 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      background: #f9f9f9;
    }

    .tab.active {
      color: #1da1f2;
      border-bottom-color: #1da1f2;
      font-weight: 500;
    }

    .card-body {
      padding: 20px;
    }

    .search-box {
      margin-bottom: 16px;
    }

    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .search-box input:focus {
      outline: none;
      border-color: #1da1f2;
    }

    .count {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }

    .list {
      max-height: 600px;
      overflow-y: auto;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .list-item:hover {
      background: #f9f9f9;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-weight: 500;
      color: #333;
      font-size: 15px;
      margin-bottom: 4px;
    }

    .item-username {
      font-size: 13px;
      color: #666;
    }

    .item-link {
      color: #1da1f2;
      text-decoration: none;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .item-link:hover {
      background: #e8f4fd;
      text-decoration: none;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>X Backup ç®¡ç†åå°</h1>
    <div class="header-right">
      <span>ç®¡ç†å‘˜</span>
      <a href="/admin" class="btn btn-light">è¿”å›é¦–é¡µ</a>
    </div>
  </div>

  <div class="container">
    <a href="javascript:history.back()" class="back-link">â† è¿”å›</a>

    <h2 class="page-title" id="page-title">å¤‡ä»½è¯¦æƒ…</h2>

    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('following')">å…³æ³¨åˆ—è¡¨</button>
        <button class="tab" onclick="switchTab('likes')">ç‚¹èµåˆ—è¡¨</button>
      </div>
      <div class="card-body">
        <div class="search-box">
          <input type="text" id="search" placeholder="æœç´¢ç”¨æˆ·åæˆ–åç§°..." oninput="filterList()">
        </div>
        <div class="count" id="count"></div>
        <div class="list" id="list">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let authToken = localStorage.getItem('adminAuth');

    // æ£€æŸ¥ç™»å½•
    if (!authToken) {
      window.location.href = '/admin';
    }

    // è·å–å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const accountId = urlParams.get('id');
    const accountName = urlParams.get('name') || 'æœªçŸ¥';

    if (!accountId) {
      window.location.href = '/admin';
    }

    // è®¾ç½®æ ‡é¢˜
    document.getElementById('page-title').textContent = decodeURIComponent(accountName) + ' çš„å¤‡ä»½';
    document.title = decodeURIComponent(accountName) + ' çš„å¤‡ä»½ - X Backup ç®¡ç†åå°';

    // æ•°æ®
    let backupData = { following: [], likes: [] };
    let currentTab = 'following';

    // APIè¯·æ±‚
    async function api(path) {
      const res = await fetch(API_BASE + path, {
        headers: {
          'Authorization': 'Basic ' + authToken,
          'Content-Type': 'application/json'
        }
      });
      if (res.status === 401) {
        localStorage.removeItem('adminAuth');
        window.location.href = '/admin';
        return;
      }
      return res.json();
    }

    // åŠ è½½å¤‡ä»½æ•°æ®
    async function loadBackup() {
      try {
        const res = await api('/accounts/' + accountId + '/backup');
        if (res.success) {
          backupData = {
            following: res.following || [],
            likes: res.likes || []
          };
          updateTabCounts();
          renderList();
        } else {
          document.getElementById('list').innerHTML = `
            <div class="empty">
              <div class="empty-icon">ğŸ˜•</div>
              <div>åŠ è½½å¤±è´¥ï¼š${res.error}</div>
            </div>
          `;
        }
      } catch (e) {
        document.getElementById('list').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ˜•</div>
            <div>åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
          </div>
        `;
      }
    }

    // æ›´æ–°æ ‡ç­¾é¡µæ•°é‡
    function updateTabCounts() {
      const tabs = document.querySelectorAll('.tab');
      tabs[0].textContent = `å…³æ³¨åˆ—è¡¨ (${backupData.following.length})`;
      tabs[1].textContent = `ç‚¹èµåˆ—è¡¨ (${backupData.likes.length})`;
    }

    // åˆ‡æ¢æ ‡ç­¾
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0 && tab === 'following') || (i === 1 && tab === 'likes'));
      });
      document.getElementById('search').value = '';
      renderList();
    }

    // è¿‡æ»¤åˆ—è¡¨
    function filterList() {
      renderList();
    }

    // è·å–æœ‰æ•ˆç”¨æˆ·å
    function getValidUsername(username) {
      if (!username || username === 'undefined' || username === 'null') {
        return null;
      }
      return username;
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderList() {
      const searchText = document.getElementById('search').value.trim().toLowerCase();
      const list = currentTab === 'following' ? backupData.following : backupData.likes;

      let filtered = list;
      if (searchText) {
        filtered = list.filter(item =>
          (item.username && item.username.toLowerCase().includes(searchText)) ||
          (item.name && item.name.toLowerCase().includes(searchText))
        );
      }

      const countEl = document.getElementById('count');
      if (searchText) {
        countEl.textContent = `å…± ${list.length} æ¡ï¼Œç­›é€‰æ˜¾ç¤º ${filtered.length} æ¡`;
      } else {
        countEl.textContent = `å…± ${list.length} æ¡`;
      }

      const listEl = document.getElementById('list');
      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="empty">
            <div class="empty-icon">${list.length === 0 ? 'ğŸ“­' : 'ğŸ”'}</div>
            <div>${list.length === 0 ? 'æš‚æ— æ•°æ®' : 'æ— åŒ¹é…ç»“æœ'}</div>
          </div>
        `;
        return;
      }

      if (currentTab === 'following') {
        listEl.innerHTML = filtered.map(user => {
          const validUsername = getValidUsername(user.username);
          return `
            <div class="list-item">
              <div class="item-info">
                <div class="item-name">${user.name || 'æœªçŸ¥'}</div>
                <div class="item-username">${validUsername ? '@' + validUsername : 'ç”¨æˆ·åæœªçŸ¥'}</div>
              </div>
              ${validUsername ? `<a class="item-link" href="https://x.com/${validUsername}" target="_blank">æŸ¥çœ‹ä¸»é¡µ</a>` : ''}
            </div>
          `;
        }).join('');
      } else {
        listEl.innerHTML = filtered.map(tweet => {
          const validUsername = getValidUsername(tweet.username);
          return `
            <div class="list-item">
              <div class="item-info">
                <div class="item-name">${tweet.name || 'æœªçŸ¥å†…å®¹'}</div>
                <div class="item-username">${validUsername ? '@' + validUsername : 'ç”¨æˆ·åæœªçŸ¥'}</div>
              </div>
              ${tweet.id && validUsername ? `<a class="item-link" href="https://x.com/${validUsername}/status/${tweet.id}" target="_blank">æŸ¥çœ‹æ¨æ–‡</a>` : ''}
            </div>
          `;
        }).join('');
      }
    }

    // åˆå§‹åŒ–
    loadBackup();
  </script>
</body>
</html>
