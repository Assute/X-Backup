<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·è¯¦æƒ… - X Backup ç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f8fa;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1da1f2, #0d8bd9);
      color: #fff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header h1 {
      font-size: 18px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-right span {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-light {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }

    .btn-light:hover {
      background: rgba(255,255,255,0.3);
    }

    .container {
      padding: 24px;
    }

    .breadcrumb {
      margin-bottom: 20px;
      font-size: 14px;
      color: #666;
    }

    .breadcrumb a {
      color: #1da1f2;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .user-header {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .user-header h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 16px;
    }

    .user-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .info-item .label {
      font-size: 13px;
      color: #666;
    }

    .info-item .value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h3 {
      font-size: 16px;
      color: #333;
    }

    .card-body {
      padding: 20px;
    }

    .account-card {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #eee;
    }

    .account-card:last-child {
      margin-bottom: 0;
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .account-main {
      flex: 1;
    }

    .account-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }

    .account-username {
      color: #666;
      font-size: 14px;
    }

    .account-username a {
      color: #1da1f2;
      text-decoration: none;
    }

    .account-username a:hover {
      text-decoration: underline;
    }

    .account-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-green {
      background: #e6f9ed;
      color: #17bf63;
    }

    .badge-gray {
      background: #f0f0f0;
      color: #666;
    }

    .account-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-item .stat-label {
      font-size: 12px;
      color: #666;
    }

    .stat-item .stat-value {
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .stat-item .stat-value.highlight {
      color: #1da1f2;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #1da1f2;
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .user-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    .btn-danger {
      background: #e0245e;
      color: #fff;
    }

    .btn-danger:hover {
      background: #c11e52;
    }

    .btn-primary {
      background: #1da1f2;
      color: #fff;
    }

    .btn-primary:hover {
      background: #0d8bd9;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      padding: 24px;
    }

    .modal-content h3 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
    }

    .modal-content input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .modal-content input:focus {
      outline: none;
      border-color: #1da1f2;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-buttons .btn {
      padding: 10px 20px;
    }

    /* æŸ¥çœ‹å¤‡ä»½é“¾æ¥æ ·å¼ */
    .view-backup-link {
      color: #1da1f2;
      text-decoration: none;
      font-size: 14px;
    }

    .view-backup-link:hover {
      text-decoration: underline;
    }

    .task-card {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 16px 20px;
      margin-bottom: 12px;
      border: 1px solid #eee;
    }

    .task-card:last-child {
      margin-bottom: 0;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .task-accounts {
      font-size: 14px;
      color: #333;
    }

    .task-accounts .arrow {
      color: #1da1f2;
      margin: 0 8px;
    }

    .task-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .task-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .task-status.running {
      background: #d4edda;
      color: #155724;
    }

    .task-status.paused {
      background: #e2e3e5;
      color: #383d41;
    }

    .task-status.completed {
      background: #cce5ff;
      color: #004085;
    }

    .task-status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .task-progress {
      display: flex;
      gap: 24px;
      font-size: 13px;
      color: #666;
    }

    .task-progress-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-progress-item .count {
      color: #1da1f2;
      font-weight: 500;
    }

    .card + .card {
      margin-top: 24px;
    }

    /* æ ‡ç­¾é¡µæ ·å¼ */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 0;
    }

    .tab-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #1da1f2;
    }

    .tab-btn.active {
      color: #1da1f2;
      border-bottom-color: #1da1f2;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>X Backup ç®¡ç†åå°</h1>
    <div class="header-right">
      <span>ç®¡ç†å‘˜</span>
      <a href="/admin" class="btn btn-light">è¿”å›åˆ—è¡¨</a>
    </div>
  </div>

  <div class="container">
    <a href="/admin" class="back-link">â† è¿”å›ç”¨æˆ·åˆ—è¡¨</a>

    <div id="content">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- ä¿®æ”¹å¯†ç å¼¹çª— -->
  <div id="password-modal" class="modal">
    <div class="modal-content">
      <h3>ä¿®æ”¹å¯†ç </h3>
      <input type="password" id="new-password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
      <div class="modal-buttons">
        <button class="btn" onclick="closePasswordModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitPassword()">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
  <div id="delete-modal" class="modal">
    <div class="modal-content">
      <h3>ç¡®è®¤åˆ é™¤</h3>
      <p style="margin-bottom: 20px; color: #666;">ç¡®å®šè¦åˆ é™¤è¯¥ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰Xè´¦å·å’Œå¤‡ä»½æ•°æ®ï¼Œä¸”ä¸å¯æ¢å¤ã€‚</p>
      <div class="modal-buttons">
        <button class="btn" onclick="closeDeleteModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="confirmDelete()">ç¡®å®šåˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';
    let authToken = localStorage.getItem('adminAuth');

    // æ£€æŸ¥ç™»å½•
    if (!authToken) {
      window.location.href = '/admin';
    }

    // è·å–ç”¨æˆ·ID
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');

    if (!userId) {
      window.location.href = '/admin';
    }

    // APIè¯·æ±‚
    async function api(path, options = {}) {
      const res = await fetch(API_BASE + path, {
        headers: {
          'Authorization': 'Basic ' + authToken,
          'Content-Type': 'application/json'
        },
        ...options
      });
      if (res.status === 401) {
        localStorage.removeItem('adminAuth');
        window.location.href = '/admin';
        return;
      }
      return res.json();
    }

    // åŠ è½½ç”¨æˆ·è¯¦æƒ…
    async function loadUserDetail() {
      try {
        const res = await api('/users/' + userId);
        if (res.success) {
          renderUserDetail(res.user, res.accounts, res.tasks || []);
        } else {
          document.getElementById('content').innerHTML = `
            <div class="empty">
              <div class="empty-icon">ğŸ˜•</div>
              <div>åŠ è½½å¤±è´¥ï¼š${res.error}</div>
            </div>
          `;
        }
      } catch (e) {
        document.getElementById('content').innerHTML = `
          <div class="empty">
            <div class="empty-icon">ğŸ˜•</div>
            <div>åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>
          </div>
        `;
      }
    }

    // æ¸²æŸ“ç”¨æˆ·è¯¦æƒ…
    function renderUserDetail(user, accounts, tasks) {
      document.title = user.username + ' - X Backup ç®¡ç†åå°';

      let html = `
        <div class="user-header">
          <h2>${user.username}</h2>
          <div class="user-info-grid">
            <div class="info-item">
              <span class="label">ç”¨æˆ·ID</span>
              <span class="value">${user._id.substring(0, 8)}...</span>
            </div>
            <div class="info-item">
              <span class="label">æ³¨å†Œæ—¶é—´</span>
              <span class="value">${formatDate(user.createdAt)}</span>
            </div>
            <div class="info-item">
              <span class="label">Xè´¦å·æ•°é‡</span>
              <span class="value">${accounts.length} ä¸ª</span>
            </div>
            <div class="info-item">
              <span class="label">ä»»åŠ¡æ•°é‡</span>
              <span class="value">${tasks.length} ä¸ª</span>
            </div>
          </div>
          <div class="user-actions">
            <button class="btn btn-primary" onclick="showPasswordModal()">ä¿®æ”¹å¯†ç </button>
            <button class="btn btn-danger" onclick="showDeleteModal()">åˆ é™¤ç”¨æˆ·</button>
          </div>
        </div>

        <div class="card">
          <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('accounts')">Xè´¦å· (${accounts.length})</button>
            <button class="tab-btn" onclick="switchTab('tasks')">è½¬ç§»ä»»åŠ¡ (${tasks.length})</button>
          </div>
          <div class="card-body">
            <!-- è´¦å·åˆ—è¡¨ -->
            <div id="accounts-tab" class="tab-content active">
      `;

      if (accounts.length === 0) {
        html += `
          <div class="empty">
            <div class="empty-icon">ğŸ“­</div>
            <div>è¯¥ç”¨æˆ·æš‚æœªæ·»åŠ ä»»ä½•Xè´¦å·</div>
          </div>
        `;
      } else {
        accounts.forEach(acc => {
          html += `
            <div class="account-card">
              <div class="account-header">
                <div class="account-main">
                  <div class="account-name">${acc.xName || acc.xUsername || 'æœªçŸ¥'}</div>
                  <div class="account-username">
                    @${acc.xUsername || 'æœªçŸ¥'} Â·
                    <a href="https://x.com/${acc.xUsername}" target="_blank">æŸ¥çœ‹ä¸»é¡µ</a>
                  </div>
                </div>
                <div class="account-badges">
                  ${acc.hasFollowingBackup ? '<span class="badge badge-green">å·²å¤‡ä»½å…³æ³¨</span>' : '<span class="badge badge-gray">æœªå¤‡ä»½å…³æ³¨</span>'}
                  ${acc.hasLikesBackup ? '<span class="badge badge-green">å·²å¤‡ä»½ç‚¹èµ</span>' : '<span class="badge badge-gray">æœªå¤‡ä»½ç‚¹èµ</span>'}
                </div>
              </div>
              <div class="account-stats">
                <div class="stat-item">
                  <span class="stat-label">Xç”¨æˆ·ID</span>
                  <span class="stat-value">${acc.xUserId}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">å…³æ³¨æ•°é‡</span>
                  <span class="stat-value highlight">${acc.followingCount}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">ç‚¹èµæ•°é‡</span>
                  <span class="stat-value highlight">${acc.likesCount}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">æœ€ååŒæ­¥</span>
                  <span class="stat-value">${acc.lastSyncAt ? formatDate(acc.lastSyncAt) : 'ä»æœªåŒæ­¥'}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">æ·»åŠ æ—¶é—´</span>
                  <span class="stat-value">${formatDate(acc.createdAt)}</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label"></span>
                  <span class="stat-value">
                    ${acc.hasFollowingBackup || acc.hasLikesBackup
                      ? `<a href="/admin-backup.html?id=${acc._id}&name=${encodeURIComponent(acc.xName || acc.xUsername)}" class="view-backup-link">æŸ¥çœ‹å¤‡ä»½</a>`
                      : '<span style="color:#999">æŸ¥çœ‹å¤‡ä»½</span>'}
                  </span>
                </div>
              </div>
            </div>
          `;
        });
      }

      html += `
            </div>
            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div id="tasks-tab" class="tab-content">
      `;

      if (tasks.length === 0) {
        html += `
          <div class="empty">
            <div class="empty-icon">ğŸ“‹</div>
            <div>è¯¥ç”¨æˆ·æš‚æœªåˆ›å»ºä»»ä½•ä»»åŠ¡</div>
          </div>
        `;
      } else {
        tasks.forEach(task => {
          const statusMap = {
            'pending': 'ç­‰å¾…ä¸­',
            'running': 'è¿è¡Œä¸­',
            'paused': 'å·²æš‚åœ',
            'completed': 'å·²å®Œæˆ',
            'error': 'å‡ºé”™'
          };
          const sourceName = task.sourceAccount ? (task.sourceAccount.xName || task.sourceAccount.xUsername) : 'å·²åˆ é™¤';
          const targetName = task.targetAccount ? (task.targetAccount.xName || task.targetAccount.xUsername) : 'å·²åˆ é™¤';

          // è®¡ç®—é¢„ä¼°æ—¶é—´
          const estimateTime = calculateEstimateTime(task);

          // è·å–é™æµé…ç½®
          const config = task.rateLimitConfig || {};
          const followLimit = `${config.followsPerHour || 5}/h, ${config.followsPerDay || 20}/d`;
          const likeLimit = `${config.likesPerHour || 10}/h, ${config.likesPerDay || 30}/d`;

          html += `
            <div class="task-card">
              <div class="task-header">
                <div class="task-accounts">
                  <span>${sourceName}</span>
                  <span class="arrow">â†’</span>
                  <span>${targetName}</span>
                </div>
                <span class="task-status ${task.status}">${statusMap[task.status] || task.status}</span>
              </div>
              <div class="task-progress">
                <div class="task-progress-item">
                  å…³æ³¨: <span class="count">${task.completedFollows}/${task.completedFollows + task.pendingFollows}</span>
                </div>
                <div class="task-progress-item">
                  ç‚¹èµ: <span class="count">${task.completedLikes}/${task.completedLikes + task.pendingLikes}</span>
                </div>
                <div class="task-progress-item">
                  ${formatDate(task.createdAt)}
                </div>
              </div>
              <div class="task-progress" style="margin-top: 8px;">
                <div class="task-progress-item">
                  é™åˆ¶: å…³æ³¨ ${followLimit} | ç‚¹èµ ${likeLimit}
                </div>
              </div>
              <div class="task-progress" style="margin-top: 4px; color: #1da1f2;">
                <div class="task-progress-item">
                  ${estimateTime}
                </div>
              </div>
            </div>
          `;
        });
      }

      html += `
            </div>
          </div>
        </div>
      `;

      document.getElementById('content').innerHTML = html;
    }

    // è®¡ç®—é¢„ä¼°å®Œæˆæ—¶é—´
    function calculateEstimateTime(task) {
      const pendingFollows = task.pendingFollows || 0;
      const pendingLikes = task.pendingLikes || 0;

      if (pendingFollows === 0 && pendingLikes === 0) {
        return 'å·²å®Œæˆå…¨éƒ¨ä»»åŠ¡';
      }

      const config = task.rateLimitConfig || {};
      const followsPerDay = Math.min((config.followsPerHour || 5) * 24, config.followsPerDay || 20);
      const likesPerDay = Math.min((config.likesPerHour || 10) * 24, config.likesPerDay || 30);

      // è®¡ç®—éœ€è¦çš„å¤©æ•°
      const followDays = followsPerDay > 0 ? Math.ceil(pendingFollows / followsPerDay) : 0;
      const likeDays = likesPerDay > 0 ? Math.ceil(pendingLikes / likesPerDay) : 0;
      const totalDays = Math.max(followDays, likeDays);

      if (totalDays === 0) {
        return 'é¢„è®¡ä»Šå¤©å†…å®Œæˆ';
      } else if (totalDays === 1) {
        return 'é¢„è®¡éœ€è¦ 1 å¤©å®Œæˆ';
      } else {
        return `é¢„è®¡éœ€è¦ ${totalDays} å¤©å®Œæˆ`;
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // åˆå§‹åŒ–
    loadUserDetail();

    // æ˜¾ç¤ºä¿®æ”¹å¯†ç å¼¹çª—
    function showPasswordModal() {
      document.getElementById('password-modal').classList.add('show');
      document.getElementById('new-password').value = '';
      document.getElementById('new-password').focus();
    }

    // å…³é—­ä¿®æ”¹å¯†ç å¼¹çª—
    function closePasswordModal() {
      document.getElementById('password-modal').classList.remove('show');
    }

    // æäº¤å¯†ç ä¿®æ”¹
    async function submitPassword() {
      const newPassword = document.getElementById('new-password').value;
      if (!newPassword || newPassword.length < 3) {
        alert('å¯†ç é•¿åº¦è‡³å°‘3ä½');
        return;
      }

      try {
        const res = await api('/users/' + userId + '/password', {
          method: 'PUT',
          body: JSON.stringify({ newPassword })
        });

        if (res.success) {
          alert('å¯†ç ä¿®æ”¹æˆåŠŸ');
          closePasswordModal();
        } else {
          alert('ä¿®æ”¹å¤±è´¥ï¼š' + res.error);
        }
      } catch (e) {
        alert('ä¿®æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    }

    // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¼¹çª—
    function showDeleteModal() {
      document.getElementById('delete-modal').classList.add('show');
    }

    // å…³é—­åˆ é™¤ç¡®è®¤å¼¹çª—
    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.remove('show');
    }

    // ç¡®è®¤åˆ é™¤
    async function confirmDelete() {
      try {
        const res = await api('/users/' + userId, {
          method: 'DELETE'
        });

        if (res.success) {
          alert('ç”¨æˆ·å·²åˆ é™¤');
          window.location.href = '/admin';
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + res.error);
        }
      } catch (e) {
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
      }
    }

    // å›è½¦æäº¤å¯†ç 
    document.getElementById('new-password').addEventListener('keypress', e => {
      if (e.key === 'Enter') submitPassword();
    });

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.getElementById('password-modal').addEventListener('click', e => {
      if (e.target.id === 'password-modal') closePasswordModal();
    });
    document.getElementById('delete-modal').addEventListener('click', e => {
      if (e.target.id === 'delete-modal') closeDeleteModal();
    });
  </script>
</body>
</html>
